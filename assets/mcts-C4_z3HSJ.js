const u=Array(64).fill(null);u[27]="w";u[28]="b";u[35]="b";u[36]="w";const w=[100,-25,10,5,5,10,-25,100,-25,-25,1,1,1,1,-25,-25,10,1,5,2,2,5,1,10,5,1,2,1,1,2,1,5,5,1,2,1,1,2,1,5,10,1,5,2,2,5,1,10,-25,-25,1,1,1,1,-25,-25,100,-25,10,5,5,10,-25,100],d=[-9,-8,-7,-1,1,7,8,9],m=5e3;function h(t,i,e){if(i<0||i>=64||t[i])return[];const l=e==="b"?"w":"b",r=[];for(const o of d){const n=[];let c=i+o;if(!(Math.abs(i%8-c%8)>1))for(;c>=0&&c<64&&!(Math.abs(c%8-(c-o)%8)>1);){const a=t[c];if(a===l)n.push(c);else if(a===e){r.push(...n);break}else break;c+=o}}return r}function g(t,i,e){const l=h(t,i,e);if(l.length===0)return null;const r=[...t];return r[i]=e,l.forEach(o=>r[o]=e),r}function b(t,i){for(let e=0;e<64;e++)if(t[e]===null&&h(t,e,i).length>0)return!1;return!0}function v(t){return t.reduce((i,e)=>(e==="b"?i.black++:e==="w"&&i.white++,i),{black:0,white:0})}function M(t){return t.black>t.white?"Black":t.white>t.black?"White":"Draw"}function f(t){const{black:i,white:e}=v(t),l=b(t,"b"),r=b(t,"w");return i+e===64||l&&r}function T(t){const i=t.player==="b"?"w":"b",e=[];for(let l=0;l<64;l++){const r=g(t.board,l,t.player);r!==null&&e.push({parent:t,move:l,board:r,player:i,value:0,visit:0,children:[]})}return e}function I(t,i=Math.SQRT2){let e=null,l=-1/0;for(const r of t.children){if(r.visit===0)return r;const n=-r.value/r.visit+i*Math.sqrt(Math.log(t.visit)/r.visit);(e===null||n>l)&&(e=r,l=n)}return e}function k(t){const i=Math.min(...t.map(n=>w[n.move])),e=i<=0?-i+1:0,l=t.map(n=>({...n,weight:w[n.move]+e})),r=l.reduce((n,c)=>n+c.weight,0);let o=Math.random()*r;for(const n of l)if(o-=n.weight,o<=0)return n;return l[l.length-1]}function P(t){const i=t.player,e=t.board.slice();let l=t.player;for(;!f(e);){const o=[];for(let s=0;s<64;s++){const p=h(e,s,l);p.length>0&&o.push({move:s,piecesToFlip:p})}if(o.length===0){l=l==="b"?"w":"b";continue}const{move:n,piecesToFlip:c}=k(o),a=l==="b"?"w":"b";e[n]=l,c.forEach(s=>e[s]=l),l=a}switch(M(v(e))){case"Draw":return 0;case"Black":return i==="b"?1:-1;case"White":return i==="w"?1:-1}}function y(t,i){let e=t;for(;e!==null;)e.value+=i,e.visit++,e=e.parent}function F(t,i,e){const l={parent:null,move:null,board:t,player:i,value:0,visit:0,children:[]};for(;performance.now()-e<m;){let n=l;for(;n.children.length>0&&!f(n.board);)n=I(n);f(n.board)||(n.children.length===0&&(n.children=T(n)),n.children.length>0&&(n=n.children[0]));const c=P(n);y(n,c)}let r=null,o=-1;for(const n of l.children)n.visit>o&&(o=n.visit,r=n.move);return r}self.onmessage=t=>{const{board:i,player:e}=t.data,l=performance.now(),r=F(i,e,l);self.postMessage(r)};
